@inherits LayoutComponentBase
@inject IndexedDbService IndexedDbService

<div class="drawer lg:drawer-open">
    <input id="main-drawer" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col min-h-screen bg-base-200">
        <!-- Navbar -->
        <header class="navbar bg-base-100 shadow-sm border-b border-base-300 top-0 z-30 sticky">
            <div class="flex-none lg:hidden">
                <label for="main-drawer" class="btn btn-square btn-ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </label>
            </div>
            <div class="flex-1 px-4 md:px-6">
                <div class="hidden md:flex items-center w-full max-w-md relative group">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-base-content/40 group-focus-within:text-primary transition-colors text-xs"></i>
                    </span>
                    <input type="text"
                           class="input input-bordered input-sm w-full pl-9 focus:input-primary transition-all"
                           placeholder="Search everything..." />
                </div>
            </div>
            <div class="flex-none gap-2">
                <!-- Notifications -->
                <button class="btn btn-ghost btn-circle">
                    <div class="indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="badge badge-xs badge-primary indicator-item"></span>
                    </div>
                </button>

                <!-- User Dropdown -->
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar border border-base-300">
                        <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold">
                            @UserInitials
                        </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52 border border-base-300">
                        <li>
                            <div class="flex flex-col items-start px-4 py-2 border-b border-base-200 mb-2">
                                <p class="text-sm font-bold">@UserDisplayName</p>
                                <p class="text-xs text-base-content/60">@UserRoleName</p>
                            </div>
                        </li>
                        <li><a class="justify-between">Profile<span class="badge">New</span></a></li>
                        <li><a>Settings</a></li>
                        <li><a class="text-error">Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Main Page Content -->
        <main class="flex-1 p-6 md:p-8">
            <div class="max-w-7xl mx-auto">
                @Body
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t border-base-300">
            <aside>
                <p>Copyright Â© @DateTime.Now.Year - DotNet8 Banking Management System</p>
            </aside>
        </footer>
    </div>

    <!-- Sidebar -->
    <div class="drawer-side z-40">
        <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
        <div class="flex flex-col w-72 min-h-full bg-base-100 border-r border-base-300 shadow-2xl">
            <div class="h-16 flex items-center px-4 md:px-6 border-b border-base-300 bg-base-100 sticky top-0 z-10">
                <a href="/" class="flex items-center gap-3 active:scale-95 transition-transform">
                    <div class="bg-primary p-2 rounded-lg text-primary-content shadow-lg shadow-primary/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                        </svg>
                    </div>
                    <span class="text-xl font-black text-base-content tracking-tight uppercase">IBanking</span>
                </a>
            </div>

            <div class="flex-1 overflow-y-auto slim-scrollbar">
                <NavMenu IsSetupOpen="isSetupOpen"
                         IsUsersOpen="isUsersOpen"
                         IsSettingOpen="isSettingOpen"
                         ToggleSetup="ToggleSetup"
                         ToggleUsers="ToggleUsers"
                         ToggleSetting="ToggleSetting"
                         OnNavigate="CloseMobileMenu" />
            </div>

            <div class="p-4 border-t border-base-300 bg-base-200/50">
                <div class="flex items-center gap-3 px-3 py-3 rounded-xl">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-lg w-10">
                            <span class="text-xs font-bold">@UserInitials</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs font-bold truncate">@UserDisplayName</p>
                        <p class="text-[10px] opacity-70 truncate font-semibold">@UserRoleName</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isSetupOpen = false;
    private bool isUsersOpen = false;
    private bool isSettingOpen = false;

    private void ToggleSetup() => isSetupOpen = !isSetupOpen;
    private void ToggleUsers() => isUsersOpen = !isUsersOpen;
    private void ToggleSetting() => isSettingOpen = !isSettingOpen;
    private void CloseMobileMenu()
    {
        // This is handled by daisyUI checkbox on mobile usually, 
        // but we might want to manually close it too.
    }

    private string UserDisplayName { get; set; } = "Sann Lynn Htun";
    private string UserRoleName { get; set; } = "Administrator";
    private string UserInitials => GetInitials(UserDisplayName);

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 0)
            return "?";

        var first = char.ToUpperInvariant(parts[0][0]);
        if (parts.Length == 1)
            return first.ToString();

        var second = char.ToUpperInvariant(parts[1][0]);
        return string.Concat(first, second);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await IndexedDbService.InitializeAsync(EnumServiceExtensions.GetStoreNames());
        }
    }
}
